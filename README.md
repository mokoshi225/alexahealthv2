# Alexa 症状記録スキル

このリポジトリには、ユーザーの毎日の症状を記録するためのAlexaスキルが含まれています。定型アクションで毎日決まった時間にスキルを起動し、ユーザーの回答に基づいて症状を記録します。

## スキルの概要

*   **スキル起動時:** DynamoDBから最近のユーザーの症状データを取得し、質問リストを作成します。
*   **症状ごとの質問:** 定義された症状リストに基づいて、ユーザーに症状の有無と強さ（「強い」「少し」「無い」）を質問します。
*   **新しい症状の確認:** 全ての既存症状の質問が完了した後、ユーザーに新しい症状の自由記述での登録を促します。複数の症状が同時に回答された場合は、自然言語処理を用いて症状を分割して認識します。
*   **症状名の標準化:** 自由記述で登録された症状名に対して、類似度計算、自然言語処理、または手動でのマッピングを用いて、既存の症状リストの症状名に標準化します。
*   **データ記録と終了:** ユーザーの回答と特定された症状の強さをDynamoDBに記録し、スキルを終了します。

## プロジェクト構造

```
.
├── lambda/
│   └── custom/
│       ├── index.js
│       └── package.json
├── models/
│   └── ja-JP.json
├── alexa_skill_plan.md
└── README.md
```

*   `lambda/custom/index.js`: Alexaスキルのバックエンドロジックが含まれています。
*   `lambda/custom/package.json`: Node.jsの依存関係を定義します。
*   `models/ja-JP.json`: Alexaスキルの対話モデル（インテント、スロット、サンプル発話）を定義します。
*   `alexa_skill_plan.md`: スキルのアーキテクチャ設計と計画が記載されています。

## セットアップ手順 (Alexa Hosted Skill)

Alexa Hostedスキルは、AWSアカウントなしでAlexaスキルを開発・デプロイできる便利な環境です。以下の手順でスキルをセットアップしてください。

1.  **Alexa開発者コンソールにログイン:**
    ウェブブラウザで [https://developer.amazon.com/alexa/console/](https://developer.amazon.com/alexa/console/) にアクセスし、Amazon開発者アカウントでログインします。

2.  **新しいスキルを作成:**
    *   コンソールにログイン後、「スキルを作成」ボタンをクリックします。
    *   「スキルの名前」を入力します（例: 「症状記録スキル」）。
    *   「スキルのデフォルト言語」で「日本語」を選択します。
    *   「モデルを選択」で「カスタム」を選択します。
    *   「ホスティング方法を選択」で「Alexa-Hosted (Node.js)」を選択します。
    *   「スキルを作成」をクリックして、スキルの作成プロセスを開始します。

3.  **コードのデプロイ:**
    *   スキルが作成されると、開発者コンソールの「コード」タブに自動的にリダイレクトされます。
    *   左側のファイルツリーで `lambda/custom/index.js` を選択し、このリポジトリの [`lambda/custom/index.js`](lambda/custom/index.js) の内容をすべてコピーして、コンソールのエディタにペーストします。
    *   同様に、`lambda/custom/package.json` を選択し、このリポジトリの [`lambda/custom/package.json`](lambda/custom/package.json) の内容をすべてコピーして、コンソールのエディタにペーストします。
    *   エディタの下にある「デプロイ」ボタンをクリックして、コードを保存し、デプロイします。デプロイには数分かかる場合があります。

4.  **対話モデルのビルド:**
    *   左側のナビゲーションで「対話モデル」セクションを展開し、「JSONエディタ」をクリックします。
    *   このリポジトリの [`models/ja-JP.json`](models/ja-JP.json) の内容をすべてコピーして、コンソールのJSONエディタにペーストします。
    *   エディタの上にある「モデルをビルド」ボタンをクリックします。モデルのビルドには数分かかる場合があります。
    *   **注意:** 最近の修正により、`NewSymptomIntent` のサンプル発話 `{newSymptom}を教えて` が `{newSymptom} を教えて` に変更され、AlexaのJSONパーサーが正しく解釈できるようになりました。

5.  **DynamoDBテーブルの設定:**
    *   Alexa Hostedスキルは、永続化のために自動的にDynamoDBテーブルを作成します。
    *   `lambda/custom/index.js` 内の `persistenceAdapter` は、環境変数 `DYNAMODB_PERSISTENCE_TABLE_NAME` を使用してテーブル名を指定するように設定されています。Alexa Hostedスキル環境では、この環境変数は自動的に設定されるため、通常は追加の設定は不要です。
    *   セッション終了時やキャンセル時にも、記録された症状データを確実に保存するようにコードが更新されています。これにより、ユーザーのデータが失われることがありません。
    *   もし、DynamoDBテーブルが正しく動作しない場合は、Alexa開発者コンソールの「コード」タブから「AWS Lambda」リンクをクリックし、Lambda関数に関連付けられたDynamoDBテーブルを確認してください。

これでAlexaスキルのセットアップは完了です。テストタブでスキルをテストしたり、Alexaデバイスで実際に試したりすることができます。

## 使用方法

1.  AlexaデバイスまたはAlexaアプリで「症状記録スキル」を起動します。
    *   例: 「アレクサ、症状記録スキルを開いて」
2.  スキルが症状について質問しますので、「強い」「少し」「無い」で回答してください。
3.  全ての既存症状の質問が終わると、新しい症状の有無を尋ねられます。自由記述で症状を伝えてください。
4.  新しい症状の強さを尋ねられたら、「強い」「少し」「無い」で回答してください。
5.  全ての症状の記録が完了すると、スキルが終了します。

## 貢献

このプロジェクトへの貢献を歓迎します。バグ報告、機能提案、プルリクエストなど、お気軽にお寄せください。